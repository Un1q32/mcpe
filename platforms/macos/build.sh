#!/bin/sh
# shellcheck disable=2086
set -e

# cd to the directory this script is in
[ "${0%/*}" = "$0" ] && scriptroot="." || scriptroot="${0%/*}"
cd "$scriptroot"

# powerpc is handled further down
targets='i386-apple-macos10.4 x86_64-apple-macos10.7 arm64-apple-macos11.0'
# Must be kept in sync with the cmake executable name
bin='nbcraft'

platformdir=$PWD

workdir="$PWD/build/work"
arm64_sdk="$workdir/sdks/arm64-mac-sdk"
x86_64_sdk="$workdir/sdks/x86_64-mac-sdk"
old_sdk="$workdir/sdks/old-mac-sdk"
mkdir -p "$workdir/sdks"
cd "$workdir"

# Increase this if we ever make a change to the SDK, for example
# using a newer SDK version, and we need to invalidate the cache.
sdkver=3
if ! [ -d "$x86_64_sdk" ] || ! [ -d "$arm64_sdk" ] || ! [ -d "$old_sdk" ] || [ "$(cat sdks/sdkver 2>/dev/null)" != "$sdkver" ]; then
    printf '\nDownloading macOS SDKs...\n\n'
    (
    # for arm64
    [ -d "$arm64_sdk" ] && rm -rf "$arm64_sdk" &
    rm -f MacOSX11.3.tar.bz2
    wget -q https://github.com/alexey-lysiuk/macos-sdk/releases/download/11.3/MacOSX11.3.tar.bz2
    wait
    tar -xjf MacOSX11.3.tar.bz2
    mv MacOSX11.3.sdk "$arm64_sdk"
    ) &
    (
    # for x86_64
    [ -d "$x86_64_sdk" ] && rm -rf "$x86_64_sdk" &
    rm -f MacOSX10.7.tar.bz2
    wget -q https://github.com/alexey-lysiuk/macos-sdk/releases/download/10.7/MacOSX10.7.tar.bz2
    wait
    tar -xjf MacOSX10.7.tar.bz2 2>/dev/null
    mv MacOSX10.7.sdk "$x86_64_sdk"
    ) &
    (
    # for old stuff
    [ -d "$old_sdk" ] && rm -rf "$old_sdk" &
    rm -f MacOSX10.5.sdk.tar.xz
    wget -q https://github.com/phracker/MacOSX-SDKs/releases/download/11.3/MacOSX10.5.sdk.tar.xz
    wait
    tar -xJf MacOSX10.5.sdk.tar.xz
    mv MacOSX10.5.sdk "$old_sdk"
    # patch the sdk to fix a bug
    cd "$old_sdk"
    patch -fNp1 < "$platformdir/leopard-sdk-fix.patch"
    )
    wait
    rm ./*.tar.bz2 ./*.tar.xz
    printf '%s' "$sdkver" > sdks/sdkver
    outdated_sdk=1
fi

if command -v nproc >/dev/null; then
    ncpus="$(nproc)"
else
    ncpus="$(sysctl -n hw.ncpu)"
fi

if [ "$(uname -s)" = "Darwin" ]; then
    ar="${AR:-ar}"
    ranlib="${RANLIB:-ranlib}"
else
    ar="${AR:-"llvm-ar"}"
    ranlib="${RANLIB:-"llvm-ranlib"}"
fi

for var in ar ranlib; do
    dep="$(eval "echo \$$var")"
    if ! command -v "$dep" >/dev/null; then
        printf '%s not found!\n' "$dep"
        exit 1
    fi
done

for dep in "${CLANG:-clang}" make cmake cmp; do
    if ! command -v "$dep" >/dev/null; then
        printf '%s not found!\n' "$dep"
        exit 1
    fi
done

if [ -z "$LLVM_CONFIG" ]; then
    if command -v llvm-config >/dev/null; then
        export LLVM_CONFIG=llvm-config
    else
        export LLVM_CONFIG=false
    fi
fi

# If the repo directory is moved the ppc toolchain breaks, and the regular
# toolchain breaks under non-darwin platforms.
printf '%s' "$workdir" > workdir
if ! cmp -s workdir lastworkdir; then
    [ "$(uname -s)" != "Darwin" ] && rm -rf toolchain
    rm -rf toolchain-ppc
fi
mv workdir lastworkdir

# Increase this if we ever make a change to the toolchain, for example
# using a newer cctools-port version, and we need to invalidate the cache.
toolchainver=3
if [ "$(cat toolchain/toolchainver 2>/dev/null)" != "$toolchainver" ]; then
    rm -rf toolchain
    outdated_toolchain=1
fi

# invalidate toolchain cache if settings change
"$LLVM_CONFIG" --version > toolchainsettings || true
if ! cmp -s toolchainsettings toolchain/lasttoolchainsettings; then
    rm -rf toolchain
    outdated_toolchain=1
fi

mkdir -p toolchain/bin
mv toolchainsettings toolchain/lasttoolchainsettings
export PATH="$PWD/toolchain/bin:$PWD/toolchain-ppc/bin:$PATH"

if [ -n "$CLANG" ]; then
    ln -sf "$(command -v "$CLANG")" toolchain/bin/clang && ln -sf clang toolchain/bin/clang++
else
    rm -f toolchain/bin/clang toolchain/bin/clang++
fi
# ensure we use ccache for the toolchain build
ccache="$(command -v ccache || true)"
printf '#!/bin/sh\nexec %s clang "$@"\n' "$ccache" > toolchain/bin/nbc-clang
printf '#!/bin/sh\nexec %s clang++ "$@"\n' "$ccache" > toolchain/bin/nbc-clang++
chmod +x toolchain/bin/nbc-clang toolchain/bin/nbc-clang++

if [ -n "$outdated_toolchain" ]; then
    # this step is needed even on macOS since newer versions of Xcode will straight up not let you link for old macOS versions anymore
    printf '\nBuilding toolchain...\n\n'

    tapi_commit=640b4623929c923c0468143ff2a363a48665fa54
    rm -rf apple-libtapi-*
    wget -O- "https://github.com/tpoechtrager/apple-libtapi/archive/$tapi_commit.tar.gz" | tar -xz

    cd "apple-libtapi-$tapi_commit"
    INSTALLPREFIX="$workdir/toolchain" CC=nbc-clang CXX=nbc-clang++ ./build.sh && ./install.sh
    cd ..
    rm -rf "apple-libtapi-$tapi_commit"
    if [ "$(uname -s)" = "Darwin" ]; then
        strip -x toolchain/lib/libtapi.dylib
        install_name_tool -id '@executable_path/../lib/libtapi.dylib' \
            toolchain/lib/libtapi.dylib
    else
        strip "$(realpath toolchain/lib/libtapi.so)"
    fi

    cctools_commit=12e2486bc81c3b2be975d3e117a9d3ab6ec3970c
    rm -rf cctools-port-*
    wget -O- "https://github.com/Un1q32/cctools-port/archive/$cctools_commit.tar.gz" | tar -xz

    cd "cctools-port-$cctools_commit/cctools"
    ./configure \
        --enable-silent-rules \
        --with-llvm-config="$LLVM_CONFIG" \
        --with-libtapi="$workdir/toolchain" \
        --target=i386-apple-darwin \
        CC=nbc-clang \
        CXX=nbc-clang++
    make -C ld64 -j"$ncpus"
    strip ld64/src/ld/ld
    mv ld64/src/ld/ld ../../toolchain/bin/ld64.ld64
    make -C libmacho -j"$ncpus"
    make -C libstuff -j"$ncpus"
    make -C misc strip lipo ranlib -j"$ncpus"
    strip misc/strip misc/lipo misc/ranlib
    mv misc/strip ../../toolchain/bin/cctools-strip
    mv misc/lipo ../../toolchain/bin/lipo
    mv misc/ranlib ../../toolchain/bin/cctools-ranlib
    ln -s cctools-ranlib ../../toolchain/bin/i386-apple-darwin-ranlib # so ar can find ranlib
    make -C ar
    strip ar/ar
    mv ar/ar ../../toolchain/bin/cctools-ar
    cd ../..
    rm -rf "cctools-port-$cctools_commit"

    if [ "$(uname -s)" != "Darwin" ] && ! command -v ldid >/dev/null; then
        printf '\nBuilding ldid...\n\n'

        ldid_commit=ef330422ef001ef2aa5792f4c6970d69f3c1f478
        rm -rf ldid-*
        wget -O- "https://github.com/ProcursusTeam/ldid/archive/$ldid_commit.tar.gz" | tar -xz

        cd "ldid-$ldid_commit"
        make CXX=nbc-clang++
        strip ldid
        mv ldid ../toolchain/bin
        cd ..
        rm -rf "ldid-$ldid_commit"
    fi
    rm -rf toolchain/include
    printf '%s' "$toolchainver" > toolchain/toolchainver
fi

# The PPC toolchain is separate from the regular toolchain because
# it doesn't use llvm for LTO, so it doesn't get invalidated when llvm-config's
# version changes

# Increase this if we ever make a change to the toolchain, for example
# using a newer GCC version, and we need to invalidate the cache.
ppctoolchainver=2
ppc_triple='powerpc-apple-darwin8'
targets="$targets $ppc_triple"
if [ "$(cat toolchain-ppc/toolchainver 2>/dev/null)" != "$ppctoolchainver" ]; then
    printf '\nBuilding powerpc toolchain...\n\n'

    rm -rf toolchain-ppc
    mkdir -p toolchain-ppc/bin

    # building the real dsymutil would require a partial LLVM build, we don't need debug info that bad
    printf '#!/bin/sh\nexit 0\n' > "toolchain-ppc/bin/$ppc_triple-dsymutil"
    chmod +x "toolchain-ppc/bin/$ppc_triple-dsymutil"

    cctools_commit=a35aa0162cb2614e68db577a28fdd903fae47f20
    rm -rf cctools-port-*
    wget -O- "https://github.com/Un1q32/cctools-port/archive/$cctools_commit.tar.gz" | tar -xz

    cd "cctools-port-$cctools_commit/cctools"
    ./configure \
        --target=ppc \
        --enable-silent-rules \
        --with-llvm-config=false \
        CC=nbc-clang \
        CXX=nbc-clang++
    make -C ld64 -j"$ncpus"
    strip ld64/src/ld/ld
    mv ld64/src/ld/ld ../../toolchain-ppc/bin/ppc-ld
    make -C libstuff -j"$ncpus"
    make -C misc nm strip -j"$ncpus"
    strip misc/nm misc/strip
    mv misc/nm ../../toolchain-ppc/bin/ppc-nm
    mv misc/strip ../../toolchain-ppc/bin/ppc-strip
    make -C as/ppc -j"$ncpus"
    strip as/ppc/ppc-as
    mv as/ppc/ppc-as ../../toolchain-ppc/bin/ppc-as
    cd ../..
    rm -rf "cctools-port-$cctools_commit"

    gcc_version='15.2.0'
    rm -rf gcc-*
    wget -O- "https://ftp.gnu.org/gnu/gcc/gcc-$gcc_version/gcc-$gcc_version.tar.xz" | tar -xJ

    cd "gcc-$gcc_version"
    mkdir build
    cd build
    set --
    [ -n "$GMP" ] && set -- --with-gmp="$GMP"
    [ -n "$MPFR" ] && set -- "$@" --with-mpfr="$MPFR"
    [ -n "$MPC" ] && set -- "$@" --with-mpc="$MPC"
    ../configure \
        --prefix="$workdir/toolchain-ppc" \
        --target="$ppc_triple" \
        --disable-multilib \
        --disable-nls \
        --with-system-zlib \
        --enable-languages=c,c++,objc \
        --with-sysroot="$old_sdk" \
        --with-as="$(command -v ppc-as)" \
        --with-ld="$(command -v ppc-ld)" \
        AR_FOR_TARGET="$(command -v cctools-ar)" \
        RANLIB_FOR_TARGET="$(command -v cctools-ranlib)" \
        NM_FOR_TARGET="$(command -v ppc-nm)" \
        LIPO_FOR_TARGET="$(command -v lipo)" \
        STRIP_FOR_TARGET="$(command -v ppc-strip)" \
        "$@"
    make -j"$ncpus"
    make -j"$ncpus" install-strip
    cd ../..
    rm -rf "gcc-$gcc_version"

    rm -rf toolchain-ppc/share
    printf '%s' "$ppctoolchainver" > toolchain-ppc/toolchainver
    outdated_ppc_toolchain=1
fi

# checks if the linker we build successfully linked with LLVM and supports LTO,
# and enables LTO in the cmake build if it does.
if [ -z "$DEBUG" ]; then
    if printf 'int main(void) {return 0;}' |
        NBC_TARGET=i386-apple-macos10.4 \
        NBC_SDK="$old_sdk" \
        "$platformdir/macos-cc" -xc - -flto -o "$workdir/testout" >/dev/null 2>&1; then
        cflags='-flto'
    fi
    rm -f "$workdir/testout"
fi

if [ -n "$DEBUG" ]; then
    build=Debug
else
    build=Release
fi

# Delete old build files if build settings change or if the SDK changes.
printf '%s\n' "$DEBUG" > buildsettings
clang -v >> buildsettings 2>&1
if [ -n "$outdated_sdk" ] ||
    [ -n "$outdated_toolchain" ] ||
    [ -n "$outdated_ppc_toolchain" ] ||
    ! cmp -s buildsettings lastbuildsettings; then
    rm -rf build-*
fi
mv buildsettings lastbuildsettings

for target in $targets; do
    printf '\nBuilding for %s\n\n' "$target"
    export NBC_TARGET="$target"

    mkdir -p "build-$target"
    cd "build-$target"

    arch="${target%%-*}"
    cc="$platformdir/macos-cc"
    cxx="$platformdir/macos-c++"
    target_ar="$ar"
    target_ranlib="$ranlib"
    case $arch in
        (i386|powerpc*|ppc*)
            if [ "$arch" = 'i386' ]; then
                target_cflags="$cflags -march=pentium-m"
                set -- -DCMAKE_EXE_LINKER_FLAGS='-framework IOKit -framework Carbon -framework AudioUnit -undefined dynamic_lookup'
            else
                target_cflags=
                cc="$target-gcc"
                cxx="$target-g++"
                target_ar="cctools-ar"
                target_ranlib="cctools-ranlib"
                set -- -DCMAKE_EXE_LINKER_FLAGS='-framework IOKit -framework Carbon -framework AudioUnit -static-libgcc'
            fi
            export NBC_SDK="$old_sdk"
            platform='sdl1'
            sdl1ver=1
            if ! [ -f sdl/lib/libSDL.a ] || [ "$(cat sdl/sdl1ver 2>/dev/null)" != "$sdl1ver" ]; then
                sdl1_commit=25712c1e9270035667e1ed68f2acc5b82b441461
                rm -rf SDL-1.2-*
                if ! [ -f ../sdl1src.tar.gz ] ||
                    [ "$(sha256sum ../sdl1src.tar.gz | awk '{print $1}')" != 'd1753e9d8fc3d25cabd0198122546a3d53b5b1df0b208145cff5fc4b2d50d786' ]; then
                    wget -O ../sdl1src.tar.gz "https://github.com/libsdl-org/SDL-1.2/archive/$sdl1_commit.tar.gz"
                fi
                tar -xzf ../sdl1src.tar.gz
                cd "SDL-1.2-$sdl1_commit"
                if [ -n "$DEBUG" ]; then
                    opt='-O0'
                else
                    opt='-O2'
                fi
                if [ "$arch" != 'i386' ]; then
                    sed -e 's/-fpascal-strings//g' configure > configure.patched
                    mv configure.patched configure
                    chmod +x configure
                fi
                ./configure \
                    --host="$arch-apple-darwin" \
                    --prefix="${PWD%/*}/sdl" \
                    --disable-shared \
                    --disable-video-x11 \
                    CC="$cc" \
                    CXX="$cxx" \
                    CFLAGS="$opt $target_cflags" \
                    CXXFLAGS="$opt $target_cflags" \
                    CPPFLAGS='-DNDEBUG' \
                    AR="$target_ar" \
                    RANLIB="$target_ranlib"
                make -j"$ncpus"
                make install -j"$ncpus"
                cd ..
                printf '%s' "$sdl1ver" > sdl/sdl1ver
                rm -rf "SDL-1.2-$sdl1_commit"
            fi
            target_cflags="$target_cflags -I$PWD/sdl/include"
        ;;
        (arm64*|x86_64*)
            target_cflags="$cflags"
            case $arch in
                (arm64*)
                    export NBC_SDK="$arm64_sdk"
                    set -- -DCMAKE_EXE_LINKER_FLAGS='-undefined dynamic_lookup'
                ;;
                (x86_64*)
                    export NBC_SDK="$x86_64_sdk"
                    set --
                ;;
            esac
            platform='sdl2'
        ;;
        (*)
            echo "Unknown target"
            exit 1
        ;;
    esac

    cmake "$platformdir/../.." \
        -DCMAKE_BUILD_TYPE="$build" \
        -DCMAKE_SYSTEM_NAME=Darwin \
        -DNBC_PLATFORM="$platform" \
        -DCMAKE_FIND_ROOT_PATH_MODE_PACKAGE=ONLY \
        -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
        -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
        -DCMAKE_AR="$(command -v "$target_ar")" \
        -DCMAKE_RANLIB="$(command -v "$target_ranlib")" \
        -DCMAKE_C_COMPILER="$cc" \
        -DCMAKE_CXX_COMPILER="$cxx" \
        -DCMAKE_FIND_ROOT_PATH="$NBC_SDK/usr;$PWD/sdl" \
        -DCMAKE_SYSROOT="$NBC_SDK" \
        -DCMAKE_C_FLAGS="$target_cflags" \
        -DCMAKE_CXX_FLAGS="$target_cflags" \
        -DWERROR="${WERROR:-OFF}" \
        "$@"
    cmake --build . --parallel "$ncpus"

    cd ..
done

rm -rf ../NBCraft
mkdir -p ../NBCraft/libexec

NBC_TARGET='arm64-apple-macos11.0' \
    NBC_SDK="$arm64_sdk" \
    "$platformdir/macos-cc" \
    "$platformdir/arch.c" -Os -o arch-arm64

NBC_TARGET='unknown-apple-macos10.4' \
    NBC_SDK="$old_sdk" \
    "$platformdir/macos-cc" \
    -arch x86_64 -arch i386 \
    "$platformdir/arch.c" -Os -o arch-x86

lipo -create arch-* -output ../NBCraft/libexec/arch
[ -z "$DEBUG" ] && [ -z "$NOSTRIP" ] &&
    cctools-strip -no_code_signature_warning ../NBCraft/libexec/arch

cp -a "$platformdir/../../game/assets" ../NBCraft
cp "$platformdir/launchscript.sh" "../NBCraft/$bin"

for target in $targets; do
    arch="${target%%-*}"
    cp "build-$target/$bin" "../NBCraft/libexec/$bin-$arch"
    case $arch in
        (powerpc*|ppc*) strip='ppc-strip' ;;
        (*) strip='cctools-strip -no_code_signature_warning' ;;
    esac
    [ -z "$DEBUG" ] && [ -z "$NOSTRIP" ] &&
        $strip "../NBCraft/libexec/$bin-${target%%-*}"
done
if command -v ldid >/dev/null; then
    ldid -S ../NBCraft/libexec/arch "../NBCraft/libexec/$bin-arm64"*
else
    codesign -f -s - ../NBCraft/libexec/arch "../NBCraft/libexec/$bin-arm64"*
fi
